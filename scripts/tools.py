#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Thu Jun 14 11:29:14 2018

@author: sebastian
"""
import argparse
import csv
import os
import re
import sys

try:
    import exrex
except ImportError:
    exrex = None


def generate(expression: str, max_matches: 100):
    if exrex is None:
        print("Error: Python module exrex is needed but not available.", file=sys.stderr)
        return 2
    for ind, result in enumerate(exrex.generate(expression)):
        if ind > max_matches:
            break
        print(result)


def load_file() -> list:
    """
    Does not load the comments column(s).

    Returns: list of lists
    """
    filename = 'mapping.csv'
    for path in ['./', '../']:
        if os.path.exists(os.path.join(path, filename)):
            filename = os.path.join(path, filename)
            break
    else:
        print("File 'mapping.csv' not found in '.' and '..'.", file=sys.stderr)
        sys.exit(2)
    with open(filename) as handle:
        return [[column for column in line[:3]] for line in csv.reader(handle)]


def lookup(malware: str) -> int:
    match = False
    for expression, family, _ in load_file():
        if re.match(expression, malware, re.IGNORECASE):
            print('Found match %r -> %r.' % (malware, family))
            match = True
    if not match:
        print('Found no match.', file=sys.stderr)
        return 1
    return 0


def main():
    parser = argparse.ArgumentParser(prog='malware name mapping tools', description='Some useful tools.')
    subparsers = parser.add_subparsers(title='tools')
    parser_start = subparsers.add_parser('generate', help='Generate matching expressions for a regular expression.')
    parser_start.add_argument('-m', '--max-matches', nargs=1, default=100)
    parser_start.add_argument('expression')
    parser_start.set_defaults(func=generate)

    parser_start = subparsers.add_parser('lookup', help='Lookup a malware name.')
    parser_start.add_argument('malware')
    parser_start.set_defaults(func=lookup)

    args = parser.parse_args()
    if 'func' not in args:
        exit(parser.print_help())
    args_dict = vars(args).copy()
    del args_dict['func']
    return args.func(**args_dict)


if __name__ == "__main__":
    sys.exit(main())
