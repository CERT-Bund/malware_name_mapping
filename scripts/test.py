#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import csv
import os
import re
import sys

filename = 'mapping.csv'
for path in ['./', '../']:
    if os.path.exists(os.path.join(path, filename)):
        filename = os.path.join(path, filename)
        break
else:
    print("File 'mapping.csv' not found in '.' and '..'.", file=sys.stderr)
    sys.exit(2)


error = False
with open(filename) as handle:
    for line in handle.readlines():
        if not re.match('^"\^[^"]*\$",[0-9a-z/_-]*,(.*)?$', line):
            print("Line does not match defined format: %r." % line, file=sys.stderr)
            error = True
if error:
    sys.exit(1)

with open(filename) as handle:
    mapping = csv.reader(handle)
    expressions = [line[:2] for line in mapping]

error = False
for _, family in expressions:
    family_match = False
    for expression, other_family in expressions:
        try:
            if re.match(expression, family):
                if family != other_family:
                    print('Malware family %r matches to another family %r.' % (family, other_family))
                    error = True
                else:
                    family_match = True
        except re.error as exc:
            print('Error parsing expression %r: %r' % (expression, exc))

    if not family_match:
        print('Family %r is not matched to itself.' % family)
        error = True
if error:
    sys.exit(1)